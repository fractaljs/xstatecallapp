// Generated by Zero Schema Generator

import {
  table,
  string,
  boolean,
  number,
  json,
  enumeration,
  relationships,
  createSchema,
  type Row,
} from "@rocicorp/zero";

// Define enums

export enum CallStatus {
  PENDING = "PENDING",
  RINGING = "RINGING",
  ACTIVE = "ACTIVE",
  ENDED = "ENDED",
  MISSED = "MISSED",
  DECLINED = "DECLINED",
  FAILED = "FAILED",
}

export enum CallType {
  AUDIO = "AUDIO",
  VIDEO = "VIDEO",
}

export enum ParticipantRole {
  HOST = "HOST",
  PARTICIPANT = "PARTICIPANT",
}

export enum UserStatus {
  ONLINE = "ONLINE",
  OFFLINE = "OFFLINE",
}

export enum ParticipantStatus {
  CALLING = "CALLING",
  CONNECTED = "CONNECTED",
  DISCONNECTED = "DISCONNECTED",
  FAILED = "FAILED",
}

// Define tables

export const userTable = table("users")
  .columns({
    id: string(),
    email: string(),
    name: string().optional(),
    avatar: string().optional(),
    status: enumeration<UserStatus>(),
    createdAt: number(),
    updatedAt: number(),
  })
  .primaryKey("id");

export const callTable = table("calls")
  .columns({
    id: string(),
    initiatorId: string(),
    receiverId: string().optional(),
    status: enumeration<CallStatus>(),
    type: enumeration<CallType>(),
    startedAt: number(),
    endedAt: number().optional(),
    duration: number().optional(),
    createdAt: number(),
    updatedAt: number(),
  })
  .primaryKey("id");

export const callParticipantTable = table("call_participants")
  .columns({
    id: string(),
    callId: string(),
    userId: string(),
    joinedAt: number(),
    leftAt: number().optional(),
    role: enumeration<ParticipantRole>(),
    status: enumeration<ParticipantStatus>(),
  })
  .primaryKey("id");


// Define relationships

export const userTableRelationships = relationships(userTable, ({ many }) => ({
  initiatedCalls: many({
    sourceField: ["id"],
    destField: ["initiatorId"],
    destSchema: callTable,
  }),
  receivedCalls: many({
    sourceField: ["id"],
    destField: ["receiverId"],
    destSchema: callTable,
  }),
  callParticipants: many({
    sourceField: ["id"],
    destField: ["userId"],
    destSchema: callParticipantTable,
  })
}));

export const callTableRelationships = relationships(callTable, ({ one, many }) => ({
  initiator: one({
    sourceField: ["initiatorId"],
    destField: ["id"],
    destSchema: userTable,
  }),
  receiver: one({
    sourceField: ["receiverId"],
    destField: ["id"],
    destSchema: userTable,
  }),
  participants: many({
    sourceField: ["id"],
    destField: ["callId"],
    destSchema: callParticipantTable,
  })
}));

export const callParticipantTableRelationships = relationships(callParticipantTable, ({ one }) => ({
  call: one({
    sourceField: ["callId"],
    destField: ["id"],
    destSchema: callTable,
  }),
  user: one({
    sourceField: ["userId"],
    destField: ["id"],
    destSchema: userTable,
  })
}));

// Define schema

export const schema = createSchema(
  {
    tables: [
      userTable,
      callTable,
      callParticipantTable,
    ],
    relationships: [
      userTableRelationships,
      callTableRelationships,
      callParticipantTableRelationships,
    ],
  }
);

// Define types
export type Schema = typeof schema;
export type User = Row<typeof schema.tables.users>;
export type Call = Row<typeof schema.tables.calls>;
export type CallParticipant = Row<typeof schema.tables.call_participants>;
